
<a [routerLink]="['/app/analises']">
      <p class="description flex items-center gap-1 link">
        <i class="pi pi-fw pi-arrow-left" style="font-size: 0.75rem"></i> Voltar
      </p>
</a>

<div *ngIf="loading; else tableContent" class="flex justify-center items-center">
    <lib-spinner></lib-spinner>
</div>

<ng-template #tableContent >
  <div class="flex flex-col gap-2">
    <h1 class="font-bold text-xl">Informações da análise</h1>
    <div class="flex flex-col items-center justify-center gap-3">
      <div *ngIf="analise" class="bg-slate-800/80 border-l-4 border-slate-500 text-slate-300 p-4 rounded-r-lg my-4 w-full">
        <div class="flex">
          <div class="pr-4">
              <i class="pi pi-file text-2xl text-slate-400"></i>
          </div>

          <div class="flex-grow">
            <p class="font-bold text-white mb-3">Resumo</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">

              <div>
                  <span class="block text-slate-400 text-xs">Tipo</span>
                  <p class="font-semibold text-white">{{ analise.tipo }}</p>
              </div>
              
              <div>
                  <span class="block text-slate-400 text-xs">Proprietário</span>
                  <p class="font-semibold text-white">{{ analise.proprietario }}</p>
              </div>
              
              <div>
                  <span class="block text-slate-400 text-xs">Propriedade</span>
                  <p class="font-semibold text-white">{{ analise.propriedade }}</p>
              </div>

              <div>
                  <span class="block text-slate-400 text-xs">Laboratório</span>
                  <p class="font-semibold text-white">{{ analise.lab }}</p>
              </div>

              <div>
                  <span class="block text-slate-400 text-xs">Data da Análise</span>
                  <p class="font-semibold text-white">{{ analise.dataAnalise | date:'dd/MM/yyyy' }}</p>
              </div>

            </div>
          </div>

        </div>
      </div>
      <div class="bg-slate-800/80 border-l-4 border-slate-500 text-slate-300 p-4 rounded-r-lg my-4 w-full" role="note">
          <div class="flex items-center">
            
            <i class="pi pi-lightbulb text-2xl text-slate-400 mr-4"></i>

            <div>
              <p class="font-bold text-white">Observações Importantes</p>
              <ul class="mt-2 list-disc list-inside text-sm text-slate-300">
                <li *ngIf="!tipo">A correção de micronutrientes (além do Boro) é predominantemente feita via foliar. Para isso, é necessária uma análise de folhas. </li>
                <li *ngIf="tipo">A correção de macronutrientes é feita via solo. Para isso é necessário uma análise de solo para que sejam feitas recomendações.</li>
                <li *ngIf="tipo">Recomenda-se sempre fazer um teste de calda antes da mistura de produtos e realizar a aplicação nas horas mais frescas do dia.</li>
              </ul>
            </div>

          </div>
        </div>
        <div class="bg-amber-900/50 border-l-4 border-amber-500 text-amber-100 p-4 rounded-r-lg my-4 w-full" role="alert">
          <div class="flex items-center">
            
            <i class="pi pi-info-circle text-2xl text-amber-500 mr-4"></i>

            <div>
              <p class="font-bold text-white">Atenção:</p>
              <ul class="mt-2 list-disc list-inside text-sm text-amber-200">
                <li>Os cálculos são feitos com base na cultura do <strong>café</strong>, as recomendações podem não ser tão eficazes para talhões destinados a outras culturas.</li>
                <li>Verifique se os dados da análise estão preenchidas corretamente na tabela abaixo.</li>
                <li>A <strong>produtividade esperada</strong> da safra é crucial para o cálculo da necessidade de nutrientes.</li>
                <li>O <strong>espaçamento da lavoura</strong> define a população de plantas por hectare, impactando a dose final dos fertilizantes.</li>
              </ul>
            </div>

          </div>
        </div>
        <lib-table
          [data]="data"
          [columns]="columns"
          [loading]="loading"
          [showMoreButton]="showMoreButton"
          (refresh)="refresh()"
          [editable]="editable"
          (rowUpdate)="onRowUpdate($event)"
          [ShowSaveButton]="true"
          (save)="onSave()"
        >
        </lib-table>

      <lib-button [label]="'Solicitar recomendações'" (click)="solicitar_recomendacoes()"></lib-button>
    
    </div>  

    <div *ngIf="resultsData" class="w-full ">
        <p-card header="Resultados da Análise">

        <p-accordion  multiple="true" expandIcon="pi pi-chevron-down" collapseIcon="pi pi-chevron-up">

          <p-accordion-panel *ngFor="let plot of resultsData.plots; let i = index" [value]="i">

            <p-accordion-header>
              {{ plot.plotName }} ({{ plot.cultureType }})
            </p-accordion-header>

            <p-accordion-content>
              <div class="flex flex-col md:flex-row w-full gap-4">

              <div class="w-full">
                <lib-bar-chart 
                  [analysisData]="mapDataForCharts(plot)">
                </lib-bar-chart>
              </div>
            </div>

            </p-accordion-content>
            
          </p-accordion-panel>
        </p-accordion>

      </p-card>
      </div>
      

    <div *ngIf="fertilizerRecommendations && fertilizerRecommendations.plots.length > 0" class="mt-4">
      <p-card header="Recomendações de Fertilizantes">

        <p-accordion  multiple="true" expandIcon="pi pi-chevron-down" collapseIcon="pi pi-chevron-up">

          <p-accordion-panel *ngFor="let plot of fertilizerRecommendations.plots; let i = index" [value]="i">

            <p-accordion-header>
              {{ plot.plotName }} ({{ plot.cultureType }})
            </p-accordion-header>

            <p-accordion-content>
              <div *ngFor="let rec of plot.productRecomendations" class="mb-4">
                <lib-recommendation-display *ngIf="!tipo"  [recommendation]="rec.recommendation" />
                <lib-leaf-recommendation-display *ngIf="tipo" [leafRecommendation]="rec.leafRecommendation" />
              </div>
            </p-accordion-content>
            
          </p-accordion-panel>
        </p-accordion>

      </p-card>
    </div>
  </div>

</ng-template>